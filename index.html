<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://i.ibb.co/Cpn6qwms/image-1.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-y: auto;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            border: 1px solid transparent;
            background-clip: padding-box;
        }
        .glass::before {
             content: '';
             position: absolute;
             top: 0; right: 0; bottom: 0; left: 0;
             z-index: -1;
             margin: -1px;
             border-radius: inherit;
             background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.05));
        }
        .glass:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
        .task-item.completed .task-details p, .goal-item.completed span { text-decoration: line-through; opacity: 0.6; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slideInUp { animation: slideInUp 0.6s ease-out forwards; }

        @keyframes fadeOutShrink {
            from { opacity: 1; transform: scale(1); max-height: 100px; margin-bottom: 0.75rem; padding-top: 1rem; padding-bottom: 1rem; }
            to { opacity: 0; transform: scale(0.9); max-height: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; }
        }
        .animate-fadeOutShrink { animation: fadeOutShrink 0.4s ease-out forwards; }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(192, 132, 252, 0); }
            50% { box-shadow: 0 0 20px rgba(192, 132, 252, 0.5); }
        }
        .animate-glow { animation: glow 3s infinite ease-in-out; }
        
        .category-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; margin-top: 0.5rem; background-color: rgba(255, 255, 255, 0.2); }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #764ba2; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        input, select { transition: box-shadow 0.3s ease; }
        input:focus, select:focus { box-shadow: 0 0 15px rgba(192, 132, 252, 0.5); }

        .btn-primary { background: linear-gradient(45deg, #a855f7, #6d28d9); }
        .btn-danger { background: linear-gradient(45deg, #ef4444, #b91c1c); }
        
        .priority-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

        #chatbot-modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        #chatbot-modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .message { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1.25rem; line-height: 1.5; }
        .user-message { background-color: #6d28d9; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .bot-message { background-color: rgba(255, 255, 255, 0.2); border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.5); margin: 0 2px; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        #ai-response-container ul { list-style-position: inside; padding-left: 0.5rem; }
        #ai-response-container li { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="text-white">

    <div class="container mx-auto p-2 sm:p-4 h-full min-h-screen flex flex-col">
        <header class="text-center mb-6 pt-4 animate-slideInUp" style="animation-delay: 100ms;">
            <h1 id="greeting" class="text-4xl sm:text-5xl font-bold tracking-wider">Time Manager</h1>
        </header>

        <main class="flex-grow flex flex-col md:flex-row gap-6 md:gap-8 md:h-[calc(100vh-120px)]">
            <!-- Left Panel -->
            <div class="w-full md:w-1/3 flex flex-col gap-6 md:gap-8 md:h-full md:overflow-y-auto custom-scrollbar md:pr-2 animate-slideInUp" style="animation-delay: 200ms;">
                <div class="glass p-6 text-center">
                    <h2 class="text-3xl font-semibold" id="time-display">12:00:00 PM</h2>
                    <p class="text-lg opacity-80" id="date-display">January 1, 2024</p>
                </div>
                
                <div class="glass p-6">
                    <h2 class="text-2xl font-bold mb-3">Weekly Goals</h2>
                    <div class="w-full bg-white/20 rounded-full h-2.5 mb-4">
                        <div id="goals-progress-bar" class="bg-purple-500 h-2.5 rounded-full transition-all duration-500 btn-primary" style="width: 0%"></div>
                    </div>
                    <div id="goals-list" class="flex flex-col gap-2 max-h-32 overflow-y-auto custom-scrollbar pr-1"></div>
                    <form id="goal-form" class="flex gap-2 mt-3">
                        <input type="text" id="goal-input" placeholder="Add a new goal..." class="w-full bg-transparent border-b-2 border-white/50 p-2 rounded-lg focus:outline-none focus:border-white/80">
                        <button type="submit" class="bg-white/20 hover:bg-white/40 p-2 rounded-lg transition-transform hover:scale-105">+</button>
                    </form>
                </div>

                <div class="glass p-6 text-center">
                    <h2 class="text-2xl font-bold mb-3">Udaipur Weather</h2>
                    <div id="weather-widget" class="flex items-center justify-center gap-4"><p>Loading weather...</p></div>
                </div>
                <div class="glass p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-bold text-center flex-grow">Quote of the Day</h2>
                        <button id="refresh-quote-btn" class="p-2 rounded-full hover:bg-white/20 transition-transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        </button>
                    </div>
                    <blockquote id="quote-text" class="text-center italic opacity-90 min-h-[60px]">Loading...</blockquote>
                    <p id="quote-author" class="text-right mt-2 font-medium opacity-70"></p>
                </div>
                <div class="glass p-6">
                    <h2 class="text-2xl font-bold mb-3">âœ¨ AI Insights</h2>
                    <div class="flex flex-col gap-3">
                        <button id="ai-focus-btn" class="w-full btn-primary font-bold py-2 px-4 rounded-xl transition-transform hover:scale-105 shadow-lg flex justify-center items-center gap-2">
                            Suggest Today's Focus
                        </button>
                        <button id="ai-plan-btn" class="w-full btn-primary font-bold py-2 px-4 rounded-xl transition-transform hover:scale-105 shadow-lg flex justify-center items-center gap-2">
                            Draft Weekly Plan
                        </button>
                    </div>
                    <div id="ai-response-container" class="mt-4 bg-black/20 p-3 rounded-lg min-h-[80px]">
                        <p class="text-center text-sm opacity-70">Click a button above for AI-powered suggestions.</p>
                    </div>
                </div>
                <div class="glass p-6 text-center">
                    <h2 class="text-2xl font-bold mb-2">Focus Timer</h2>
                    <p id="pomodoro-mode" class="text-lg opacity-80 mb-2">Work</p>
                    <p id="pomodoro-cycles" class="text-sm opacity-60 mb-2">Cycle 1 of 4</p>
                    <div id="pomodoro-timer" class="text-5xl sm:text-6xl font-bold my-4">25:00</div>
                    <div class="flex justify-center gap-4">
                        <button id="pomodoro-start" class="bg-white/20 hover:bg-white/40 font-bold py-3 px-6 rounded-xl transition-transform hover:scale-105 shadow-lg">Start</button>
                        <button id="pomodoro-pause" class="bg-white/20 hover:bg-white/40 font-bold py-3 px-6 rounded-xl transition-transform hover:scale-105 shadow-lg hidden">Pause</button>
                        <button id="pomodoro-reset" class="bg-white/20 hover:bg-white/40 font-bold py-3 px-6 rounded-xl transition-transform hover:scale-105 shadow-lg">Reset</button>
                    </div>
                </div>
                <div class="glass p-6 flex-grow">
                    <h2 class="text-2xl font-bold mb-4">Add a New Task</h2>
                    <form id="task-form" class="flex flex-col gap-4">
                        <input type="text" id="task-name" placeholder="Task Name" class="w-full bg-transparent border-b-2 border-white/50 p-2 rounded-lg focus:outline-none focus:border-white/80" required>
                        <input type="text" id="task-category" list="category-suggestions" placeholder="Category (e.g., Work)" class="w-full bg-transparent border-b-2 border-white/50 p-2 rounded-lg focus:outline-none focus:border-white/80" required>
                        <datalist id="category-suggestions"></datalist>
                        <input type="date" id="task-due-date" class="w-full bg-transparent border-b-2 border-white/50 p-2 rounded-lg focus:outline-none focus:border-white/80 text-white/70" required>
                        <select id="task-priority" class="w-full bg-transparent border-b-2 border-white/50 p-2 rounded-lg focus:outline-none focus:border-white/80 text-white/70">
                            <option value="low" class="bg-gray-700">Low Priority</option>
                            <option value="medium" class="bg-gray-700">Medium Priority</option>
                            <option value="high" class="bg-gray-700">High Priority</option>
                        </select>
                        <div class="flex gap-4">
                             <button type="submit" id="add-task-btn" class="flex-grow btn-primary font-bold py-3 px-4 rounded-xl transition-transform hover:scale-105 shadow-lg flex justify-center items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>Add Task</span>
                             </button>
                             <button type="button" id="gemini-subtask-btn" class="btn-primary font-bold py-3 px-4 rounded-xl transition-transform hover:scale-105 shadow-lg flex justify-center items-center gap-2">âœ¨ Auto-Subtasks</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Right Panel: Task List -->
            <div class="w-full md:w-2/3 glass p-4 sm:p-6 flex flex-col md:h-full animate-slideInUp" style="animation-delay: 300ms;">
                <div class="mb-4">
                     <h2 class="text-2xl font-bold mb-2">Productivity Snapshot</h2>
                     <div class="bg-black/10 p-4 rounded-xl" id="productivity-chart-container">
                        <p class="text-center opacity-70">No task data for the last 7 days.</p>
                     </div>
                </div>
                <div class="flex flex-col flex-grow min-h-0">
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="task-filter" placeholder="Filter tasks..." class="w-full bg-transparent border-b-2 border-white/50 p-2 rounded-lg focus:outline-none focus:border-white/80 transition flex-grow">
                        <button id="clear-completed-btn" class="btn-danger font-bold py-2 px-4 rounded-xl transition-transform hover:scale-105 shadow-lg">Clear Completed</button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold flex-shrink-0">Your Tasks</h2>
                        <div class="bg-black/10 p-2 rounded-lg text-center text-sm">
                             <p class="font-bold" id="stats-completed-today">0</p>
                             <p class="opacity-80 text-xs">Done Today</p>
                         </div>
                    </div>
                    <div id="task-list" class="custom-scrollbar overflow-y-auto flex-grow pr-2">
                         <div id="loading-state" class="text-center py-10"><p class="text-xl">Loading tasks...</p></div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="text-center py-4 mt-auto">
            <p id="user-id-display" class="text-xs opacity-50">Not signed in</p>
        </footer>
    </div>
    
    <!-- Chatbot UI -->
    <button id="chatbot-toggle-btn" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 bg-purple-600 hover:bg-purple-700 rounded-full p-3 sm:p-4 shadow-lg transition-transform hover:scale-110 z-40 animate-glow">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path></svg>
    </button>
    <div id="chatbot-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass w-full max-w-2xl h-[80vh] flex flex-col rounded-3xl overflow-hidden">
            <header class="flex items-center justify-between p-4 border-b border-white/20 flex-shrink-0">
                <h2 class="text-xl font-bold">Koushoo Assistant</h2>
                <button id="chatbot-close-btn" class="p-2 rounded-full hover:bg-white/20 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div id="chatbot-messages" class="flex-grow p-4 flex flex-col gap-4 overflow-y-auto custom-scrollbar"></div>
            <form id="chatbot-form" class="p-4 border-t border-white/20 flex-shrink-0 flex items-center gap-4">
                <input type="text" id="chatbot-input" placeholder="Ask me anything..." class="w-full bg-transparent border-2 border-white/50 p-3 rounded-xl focus:outline-none focus:border-white/80 transition" autocomplete="off">
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 rounded-xl p-3 shadow-lg transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, auth, db, userId, tasksCollectionRef, goalsCollectionRef;
        let isAuthReady = false;
        let unsubscribeTasks, unsubscribeGoals;
        let allTasks = [], allGoals = []; 

        const greeting=document.getElementById('greeting'),timeDisplay=document.getElementById('time-display'),dateDisplay=document.getElementById('date-display'),weatherWidget=document.getElementById('weather-widget'),taskForm=document.getElementById('task-form'),taskNameInput=document.getElementById('task-name'),taskCategoryInput=document.getElementById('task-category'),categorySuggestions=document.getElementById('category-suggestions'),taskDueDateInput=document.getElementById('task-due-date'),taskPriorityInput=document.getElementById('task-priority'),addTaskBtn=document.getElementById('add-task-btn'),geminiSubtaskBtn=document.getElementById('gemini-subtask-btn'),taskList=document.getElementById('task-list'),loadingState=document.getElementById('loading-state'),userIdDisplay=document.getElementById('user-id-display'),statsCompletedToday=document.getElementById('stats-completed-today'),quoteText=document.getElementById('quote-text'),quoteAuthor=document.getElementById('quote-author'),refreshQuoteBtn=document.getElementById('refresh-quote-btn'),taskFilterInput=document.getElementById('task-filter'),clearCompletedBtn=document.getElementById('clear-completed-btn'),pomodoroTimerDisplay=document.getElementById('pomodoro-timer'),pomodoroModeDisplay=document.getElementById('pomodoro-mode'),pomodoroCyclesDisplay=document.getElementById('pomodoro-cycles'),pomodoroStartBtn=document.getElementById('pomodoro-start'),pomodoroPauseBtn=document.getElementById('pomodoro-pause'),pomodoroResetBtn=document.getElementById('pomodoro-reset');
        
        const chatbotToggleBtn=document.getElementById('chatbot-toggle-btn'),chatbotModal=document.getElementById('chatbot-modal'),chatbotCloseBtn=document.getElementById('chatbot-close-btn'),chatbotMessages=document.getElementById('chatbot-messages'),chatbotForm=document.getElementById('chatbot-form'),chatbotInput=document.getElementById('chatbot-input');
        const goalsProgressBar = document.getElementById('goals-progress-bar'),goalsList = document.getElementById('goals-list'),goalForm = document.getElementById('goal-form'),goalInput = document.getElementById('goal-input'),productivityChartContainer = document.getElementById('productivity-chart-container');
        const aiFocusBtn = document.getElementById('ai-focus-btn'), aiPlanBtn = document.getElementById('ai-plan-btn'), aiResponseContainer = document.getElementById('ai-response-container');

        const GEMINI_API_KEY = 'AIzaSyBj22v2FUIb1hFwe1hlTGDmJ-IbDeauVVM';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;

        let chatHistory = [];
        const systemPrompt = "You are a helpful productivity assistant named Koushoo Assistant, created by a developer named Koushoo. You must never mention that you are a Google model, an AI, or Gemini. Your goal is to help the user with their tasks, provide advice on time management, or answer general questions in a friendly, conversational manner.";

        async function callGeminiAPI(url, payload, retries = 3, delay = 1000) { /* Function unchanged */ }
        async function fetchAIGeneratedQuote() { /* Function unchanged */ }
        async function generateSubtasks() { /* Function unchanged */ }
        const base64ToArrayBuffer=b=>{const s=atob(b);const l=s.length;const a=new Uint8Array(l);for(let i=0;i<l;i++)a[i]=s.charCodeAt(i);return a.buffer};
        function pcmToWav(pcmData, sampleRate){ /* Function unchanged */ }
        async function speakText(text) { /* Function unchanged */ }
        function addMessageToChat(text, sender) { /* Function unchanged */ }
        async function handleSendMessage(event) { /* Function unchanged */ }
        
        function simpleMarkdownToHTML(text) {
            let html = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/(\r\n|\n|\r)/gm, "<br>");

            if (html.includes('<br>* ')) {
                 html = '<ul>' + html.split('<br>* ').slice(1).map(item => `<li>${item.split('<br>')[0]}</li>`).join('') + '</ul>';
            }
             return html;
        }

        async function suggestTodaysFocus() {
            aiResponseContainer.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div><p class="ml-2">Analyzing your tasks...</p></div>';
            const incompleteTasks = allTasks.filter(task => !task.completed);
            if (incompleteTasks.length === 0) {
                aiResponseContainer.innerHTML = '<p class="text-center text-sm opacity-70">You have no pending tasks! Great job!</p>';
                return;
            }
            const taskListString = incompleteTasks.map(t => `- ${t.name} (Priority: ${t.priority}, Due: ${t.dueDate})`).join('\n');
            const userQuery = `Today is ${new Date().toLocaleDateString()}. Based on my task list below, which 3 tasks should I focus on today to be most productive? Provide a brief reason for each. \n\nTasks:\n${taskListString}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }] };
            try {
                const result = await callGeminiAPI(GEMINI_API_URL, payload);
                const text = result.candidates[0].content.parts[0].text;
                aiResponseContainer.innerHTML = simpleMarkdownToHTML(text);
            } catch (error) {
                console.error("AI Focus Suggestion Error:", error);
                aiResponseContainer.innerHTML = '<p class="text-center text-sm text-red-400">Sorry, I couldn\'t generate suggestions right now.</p>';
            }
        }

        async function draftWeeklyPlan() {
            aiResponseContainer.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div><p class="ml-2">Drafting your weekly plan...</p></div>';
            if (allGoals.length === 0) {
                aiResponseContainer.innerHTML = '<p class="text-center text-sm opacity-70">Add some weekly goals first to generate a plan!</p>';
                return;
            }
            const goalListString = allGoals.map(g => `- ${g.text} ${g.completed ? '(Completed)' : ''}`).join('\n');
            const userQuery = `These are my goals for the week: \n${goalListString}\n\nCan you draft a simple, high-level daily focus plan (Monday to Sunday) to help me achieve them?`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }] };
            try {
                const result = await callGeminiAPI(GEMINI_API_URL, payload);
                const text = result.candidates[0].content.parts[0].text;
                aiResponseContainer.innerHTML = simpleMarkdownToHTML(text);
            } catch (error) {
                console.error("AI Weekly Plan Error:", error);
                aiResponseContainer.innerHTML = '<p class="text-center text-sm text-red-400">Sorry, I couldn\'t generate a plan right now.</p>';
            }
        }

        function updateClockAndGreeting(){const now=new Date();timeDisplay.textContent=now.toLocaleTimeString();dateDisplay.textContent=now.toLocaleDateString(void 0,{weekday:'long',year:'numeric',month:'long',day:'numeric'});const hour=now.getHours();greeting.textContent=hour<12?'Good Morning':hour<18?'Good Afternoon':'Good Evening'}
        async function fetchWeather(){const simulatedWeather={main:{temp:31},weather:[{description:'haze',icon:'50d'}]};const temp=Math.round(simulatedWeather.main.temp);const description=simulatedWeather.weather[0].description;let iconSvg='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';weatherWidget.innerHTML=`${iconSvg}<div><p class="text-3xl font-bold">${temp}Â°C</p><p class="capitalize opacity-80">${description}</p></div>`}
        const WORK_TIME=1500,SHORT_BREAK_TIME=300,LONG_BREAK_TIME=900;let pomodoroInterval,remainingTime=1500,isPaused=!0,currentMode="Work",pomodoroCycle=1;const synth=new Tone.Synth().toDestination();function formatTime(s){const m=Math.floor(s/60),c=s%60;return`${m.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`}function updatePomodoroDisplay(){pomodoroTimerDisplay.textContent=formatTime(remainingTime);pomodoroModeDisplay.textContent=currentMode;pomodoroCyclesDisplay.textContent="Work"===currentMode?`Cycle ${pomodoroCycle} of 4`:"Time for a break!"}function switchMode(){Tone.start();synth.triggerAttackRelease("Work"===currentMode?"C5":"G4","8n");"Work"===currentMode?pomodoroCycle>=4?(currentMode="Long Break",remainingTime=900,pomodoroCycle=1):(currentMode="Short Break",remainingTime=300):(currentMode="Work",remainingTime=1500,"Long Break"!==currentMode&&pomodoroCycle++);updatePomodoroDisplay()}function startTimer(){isPaused&&(isPaused=!1,pomodoroStartBtn.classList.add("hidden"),pomodoroPauseBtn.classList.remove("hidden"),pomodoroInterval=setInterval(()=>{remainingTime--,updatePomodoroDisplay(),remainingTime<=0&&(clearInterval(pomodoroInterval),switchMode(),isPaused=!0,startTimer())},1e3))}function pauseTimer(){isPaused=!0,pomodoroStartBtn.classList.remove("hidden"),pomodoroPauseBtn.classList.add("hidden"),clearInterval(pomodoroInterval)}function resetTimer(){pauseTimer(),remainingTime=1500,currentMode="Work",pomodoroCycle=1,updatePomodoroDisplay()}

        function renderGoalsAndProgress(goals) { /* Function unchanged */ }
        function renderProductivityChart(tasks) { /* Function unchanged */ }
        async function initializeFirebase() { /* Function unchanged */ }
        function getPriorityClass(p){if(p==='high')return'bg-red-500';if(p==='medium')return'bg-yellow-500';return'bg-green-500';}
        function updateCategoryDatalist(){const cats=[...new Set(allTasks.map(t=>t.category).filter(c=>c))];categorySuggestions.innerHTML=cats.map(c=>`<option value="${c}"></option>`).join('');}
        function renderTasksAndStats(tasks){ /* Function unchanged */ }
        function attachDataListeners(){ /* Function unchanged */ }
        function enterEditMode(el){ /* Function unchanged */ }
        function exitEditMode(el){ /* Function unchanged */ }

        taskForm.addEventListener('submit',async e=>{e.preventDefault();if(!isAuthReady){return;}const name=taskNameInput.value.trim();const cat=taskCategoryInput.value.trim();const due=taskDueDateInput.value;const prio=taskPriorityInput.value;if(name&&due&&prio){try{await addDoc(tasksCollectionRef,{name,category:cat,dueDate:due,priority:prio,completed:false,createdAt:serverTimestamp(),completedAt:null});taskForm.reset();}catch(err){console.error("Error adding task:",err);}}});
        taskList.addEventListener('click',async e=>{ /* Event listener unchanged */ });
        taskFilterInput.addEventListener('input',e=>{const f=e.target.value.toLowerCase();const filtered=allTasks.filter(t=>t.name.toLowerCase().includes(f)||(t.category&&t.category.toLowerCase().includes(f)));renderTasksAndStats(filtered);});
        clearCompletedBtn.addEventListener('click',async()=>{ /* Event listener unchanged */ });
        goalForm.addEventListener('submit', async (e) => { /* Event listener unchanged */ });
        goalsList.addEventListener('click', async (e) => { /* Event listener unchanged */ });
        
        pomodoroStartBtn.addEventListener('click',startTimer);pomodoroPauseBtn.addEventListener('click',pauseTimer);pomodoroResetBtn.addEventListener('click',resetTimer);refreshQuoteBtn.addEventListener('click',fetchAIGeneratedQuote);geminiSubtaskBtn.addEventListener('click',generateSubtasks);
        chatbotToggleBtn.addEventListener('click',()=>chatbotModal.classList.remove('hidden'));chatbotCloseBtn.addEventListener('click',()=>chatbotModal.classList.add('hidden'));chatbotForm.addEventListener('submit',handleSendMessage);addMessageToChat("Hello! I'm Koushoo Assistant. How can I help you be more productive today?",'bot');
        aiFocusBtn.addEventListener('click', suggestTodaysFocus);
        aiPlanBtn.addEventListener('click', draftWeeklyPlan);

        document.addEventListener('DOMContentLoaded', () => { initializeFirebase(); fetchAIGeneratedQuote(); fetchWeather(); });
        setInterval(updateClockAndGreeting, 1000);
        updateClockAndGreeting();
        updatePomodoroDisplay();
    </script>
</body>
</html>

